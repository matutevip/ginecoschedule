Objetivo
Permitir que los pacientes puedan cancelar un turno directamente desde el email de confirmaciÃ³n, con un botÃ³n que:

Usa un token seguro.

Lleva a una pÃ¡gina de confirmaciÃ³n de cancelaciÃ³n.

Si el paciente acepta, cancela el turno y actualiza su estado.

ğŸ› ï¸ Indicaciones tÃ©cnicas para el agente
1. ğŸ”‘ Generar token Ãºnico de cancelaciÃ³n
Al crear un turno nuevo en la base de datos, generar un token seguro y guardar en la tabla appointments:

ts
Copy
Edit
import { randomBytes } from "crypto";
const cancellationToken = randomBytes(32).toString("hex");
Guardar en la columna nueva cancellation_token (tipo TEXT o VARCHAR(64)).

Agregar tambiÃ©n una columna cancellation_token_expires_at (opcional, por ejemplo 48hs antes del turno).

2. ğŸ“§ Modificar email de confirmaciÃ³n de turno
Incluir un botÃ³n/link que apunte a una URL como:

ruby
Copy
Edit
https://cronosapp.com/cancelar-turno/:token
Ejemplo:

html
Copy
Edit
<a href="https://cronosapp.com/cancelar-turno/ab12cd34ef56..." style="...">Cancelar turno</a>
3. ğŸŒ Crear endpoint de frontend /cancelar-turno/:token
Al entrar con el token, mostrar:

InformaciÃ³n del turno: fecha, hora, servicio.

Pregunta: â€œÂ¿QuerÃ©s cancelar este turno?â€

Botones: âœ… Confirmar cancelaciÃ³n / âŒ Volver

4. ğŸ“² Validar y cancelar (en backend â€“ Express)
Crear el endpoint:

ts
Copy
Edit
POST /api/appointments/cancel-by-token
Body: { token: string }
Validaciones que debe hacer:

Que el token exista y estÃ© activo.

Que no haya pasado la fecha del turno.

Que el turno no estÃ© ya cancelado.

Opcional: que no haya expirado (si se usa cancellation_token_expires_at).

Si es vÃ¡lido:

Actualizar el status a cancelled_by_patient

Registrar cancelled_at con now()

Registrar cancelled_by = 'patient'

Eliminar o invalidar el token (cancellation_token = NULL)

5. âœ‰ï¸ (Opcional) Enviar email de confirmaciÃ³n de cancelaciÃ³n
â€œTu turno fue cancelado correctamente. Si querÃ©s volver a reservar, hacelo desdeâ€¦â€

ğŸ§ª Recomendaciones adicionales
Usar HTTPS (nunca enviar tokens por HTTP).

Limitar los tokens a 1 uso.

PodÃ©s usar JWT si preferÃ­s firmar el token con expiraciÃ³n, pero con un token random en base de datos ya es seguro.